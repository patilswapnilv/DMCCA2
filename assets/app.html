<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>
        </title>
        <link rel="stylesheet" href="https://ajax.aspnetcdn.com/ajax/jquery.mobile/1.1.1/jquery.mobile-1.1.1.min.css" />
        <link rel="stylesheet" href="my.css" />
        <style>
            /* App custom styles */
        </style>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js">
        </script>
        <script src="https://ajax.aspnetcdn.com/ajax/jquery.mobile/1.1.1/jquery.mobile-1.1.1.min.js">
        </script>
        <script src="my.js">
        </script>
        <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?sensor=false">
    </script>
    <script type="text/javascript">
    
    var stationArr = [];
    var trainArr = [];
    var map;
    
     function initialize() {
      
        var mapOptions = {
          center: new google.maps.LatLng(53.16836,-7.8),
          zoom: 7,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        }; //close mapOptions variable declaration
        
        map = new google.maps.Map(document.getElementById("map_canvas"),
            mapOptions);
           
           
                               
      };// close initialize();
         
           
      function loadStations(){
        $.ajax({
        	type: 'GET',
        	url: 'http://api.irishrail.ie/realtime/realtime.asmx/getAllStationsXML',
        	dataType: "xml",
    	  
        	success:function(data){

	        	$(data).find('objStation').each(function(){ 
		        	var $station = $(this)
		        	var stationName = $station.find("StationDesc").text();
		        	var stationLng = $station.find('StationLongitude').text();
		        	var stationLat = $station.find('StationLatitude').text();
		        	
		        	var objStation = {"name": stationName, "lat":stationLat, "lng":stationLng};
		        	stationArr.push(objStation);	

		        }); // close for each function
		        
		       			    
				// Markers 
		        
		        for(var i = 0; i < stationArr.length; i++)
				{    
					console.log("Station Markers");
				    var marker = new google.maps.Marker({
			        position: new google.maps.LatLng(stationArr[i]['lat'],stationArr[i]['lng']), 
			        map: map, 
			        icon: 'http://labs.google.com/ridefinder/images/mm_20_red.png',
			        title: stationArr[i]['name']
			        });
			    }

			    
			    
		     } //close success
		
		  }); //close ajax
		
		} // close loadStations
		
		
		
		
		function getTrainLocs(){
        $.ajax({
        	type: 'GET',
        	url: 'http://api.irishrail.ie/realtime/realtime.asmx/getCurrentTrainsXML',
        	dataType: "xml",
    	  
        	success:function(data){
	        	console.log("update trains");

	        	$(data).find('objTrainPositions').each(function(){ 
		        	var $train = $(this)
		        	var trainLatitude = $train.find("TrainLatitude").text();
					var trainLongitude = $train.find("TrainLongitude").text();
					var trainCode = $train.find("TrainCode").text();
					var publicMessage = $train.find("PublicMessage").text();
					var direction = $train.find("Direction").text();
		        	
		        	var objTrain = {"lat": trainLatitude, "lng":trainLongitude, "code":trainCode, "message":publicMessage, "direction":direction};
		        	trainArr.push(objTrain);	

		        }); // close for each function
		        
		        
		    	// Markers 
		        
		        for(var i = 0; i < trainArr.length; i++)
				{    
					console.log("Train Markers");
				    var marker = new google.maps.Marker({
			        position: new google.maps.LatLng(trainArr[i]['lat'],trainArr[i]['lng']), 
			        icon: 'http://google-maps-icons.googlecode.com/files/steamtrain.png',
			        map: map, 
			        title: trainArr[i]['message']
			        });
			    }
		    
			    
		     } //close success
		
		  }); //close ajax
		
		} // close getTrainLocs
		
		

		setInterval( "getTrainLocs()", 60000 ); // update train locations every 60seconds. NEED TO CLEAR OUT TRAIN MARKERS EACH TIME THIS IS DONE.
 

 
            
    </script>
    </head>
    <body onload="setSize(); loadStations(); getTrainLocs(); initialize();">
        <!-- Home -->
        <div data-role="page" id="page1">
            <div id="h" data-theme="a" data-role="header">
                <h3>
                    Map
                </h3>
            </div>
            <div data-role="content" >
                        
             <div id="map_canvas"></div>
                <a id ="b" data-role="button" href="#page1" onClick="showDialog()">
                    Options
                </a>
            </div>
        </div>
        <script type="text/javascript">
          function setSize(){
          var h = window.screen.availHeight;
          var a = document.getElementById('h').offsetHeight;
          var b = document.getElementById('b').offsetHeight;
          var w = window.availWidth;
          
          document.getElementById('map_canvas').style.height=(h-b-a-150)+'px';
          document.getElementById('map_canvas').style.width=w+'px';
          };
          
          function showDialog(){
        		AndFunction.createDialog();
        	};
        </script>
    </body>
</html>